<!DOCTYPE html>
<html>
  <head>
    <!-- Google Tag Manager -->
    <!--<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-M8WBXH7');</script>-->
    <!-- End Google Tag Manager -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href=/public/stylesheets/bs.css?random=@Environment.TickCount>
    <link rel="stylesheet" href=/public/stylesheets/styles.css?random=@Environment.TickCount>
    <link rel="stylesheet" href=/public/stylesheets/pygment_trac.css?random=@Environment.TickCount>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
    <link rel="canonical" href="made2591.github.io/posts/free-tier-cloudwatch">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
      <link rel="icon" type="image/x-icon"  href="/favicon.ico" />
    <title>AWS Free Tier, Docker and Jenkins: smart resources handling with CloudWatch Events and Slack | Matteo Madeddu</title>
    <!--[if lt IE 9]>

      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  </head>
  <body>
    <!-- Google Tag Manager (noscript) -->
    <!--<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-M8WBXH7"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <div class="wrapper">
        <section>
          <div id="header">
  <h1>
    <a id="sitename" href="">Matteo Madeddu</a>
  </h1>

  <!-- Add something about you in p tag-->
  <p>Mac OS lover, Docker fan, Go explorer, Python geek, Trello addicted.</p>
  <hr/>

  <span class="credits pull-left">
    
      <a href="/">Home</a>  | 
    
      <a href="/blog">Blog</a>  | 
    
      <a href="/archive">Archive</a>  | 
    
      <a href="/about">About</a>  | 
    
      <a href="/matteo_madeddu_cv.pdf">Resume</a>  | 
    
      <a href="/quotes">Quotes</a> 
    
  </span>

  <span class="credits pull-right social">
    
      
        <a href="https://github.com/made2591/" target="_blank"><i class="fa fa-github"></i></a>
      
    
      
        <a href="https://twitter.com/made2591" target="_blank"><i class="fa fa-twitter"></i></a>
      
    
      
        <a href="https://linkedin.com/in/mmadeddu" target="_blank"><i class="fa fa-linkedin"></i></a>
      
    
      
        <a href="https://www.facebook.com/matteo.madeddu" target="_blank"><i class="fa fa-facebook"></i></a>
      
    
  </span>


</div>


          <div class="post-title">
    <h1>AWS Free Tier, Docker and Jenkins: smart resources handling with CloudWatch Events and Slack</h1>
    <p class="text-muted">
    


    11 Mar 2018
    
     | <i class="fa fa-comment"></i> <a class="text-muted" href="/posts/free-tier-cloudwatch/#disqus_thread"></a>
    

    
      | <i class="fa fa-tag"></i>
      
        <a class="text-muted" href="/tags/#coding ">coding</a>,
      
        <a class="text-muted" href="/tags/#aws ">aws</a>,
      
        <a class="text-muted" href="/tags/#lambda ">lambda</a>,
      
        <a class="text-muted" href="/tags/#cloudwatch ">cloudwatch</a>,
      
        <a class="text-muted" href="/tags/#rules ">rules</a>,
      
        <a class="text-muted" href="/tags/#event ">event</a>,
      
        <a class="text-muted" href="/tags/#ec2 ">ec2</a>,
      
        <a class="text-muted" href="/tags/#slack ">slack</a>,
      
        <a class="text-muted" href="/tags/#docker ">docker</a>,
      
        <a class="text-muted" href="/tags/#jenkins ">jenkins</a>
      
    
  </p>
</div>

  <h3 id="introduction">Introduction</h3>
<p>If you have an <a href="http://aws.amazon.com">AWS account</a> in Free Tier, you have (updated: March, 13th 2018) 750 hours/month to run EC2 (small ones) in your VPC. You also have a lot of other resources, such as AWS Lambda functions (I wrote about them <a href="https://made2591.github.io/posts/aws-lambda">here</a> and <a href="https://made2591.github.io/posts/aws-step-functions">here</a>) and CloudWatch Events. In this article, I talk about smart resources handling and some trick - actually, not so smart XD - I setup to take the best from the services. Attention!!! Picture Spoiler</p>

<p align="center"><img src="http://image.ibb.co/hGzYvH/aws_clock.png" style="width: 100%; marker-top: -10px;" /></p>

<h3 id="ingredients">Ingredients</h3>
<p>For this article, you will need the following:</p>
<ul>
  <li>An <a href="http://aws.amazon.com">AWS account</a> (free tier it’s ok, but API Gateway is not included);</li>
  <li><a href="https://aws.amazon.com/ec2/?nc1=h_ls">AWS EC2</a>;</li>
  <li><a href="https://aws.amazon.com/en/lambda/">AWS Lambda</a>;</li>
  <li><a href="https://aws.amazon.com/cloudwatch/?nc1=h_ls">AWS CloudWatch Events</a>;</li>
  <li><a href="https://slack.com">Slack</a> - it’s a plus;</li>
</ul>

<h3 id="recipe">Recipe</h3>
<p>As I already said in a preview post on AWS Services, I recommend you to pay a lot of attention. You always have to know exactly what are you doing, to avoid surprise in billing in the end of the month. Fortunately, there are a lot of documentations on Amazon official site, so you only have to read them.</p>

<h4 id="what-and-when">What and when</h4>
<p>Ok, let’s start from the AWS EC2. You can create really slow and not-efficient machines of type t2-what? ssh-session expired. Just kidding.</p>

<p>The crucial part is that you have 750 hours free. Despite the case you can change Amazon Time, this implies that you can have an instance up and running for 1 year: in fact, 24*31 = 744 &lt; 750. That’s a huge amount of time before closing your AWS account. Of course, you will not use all this hours of execution in a month. Let’s suppose you will use 12 hours a day - it’s too much, but let’s keep it simple. This was my initial setup: in this case, you can run 2 instances for 12 hours a day for 1 years. Not’s so bad, even if the instances are really slow. You can scale di reasoning up to 6 instances for 4 hours a day…even 24 for 1 hours: if you’re wondering what you can do with 24 1 vCPU with 1 GB of RAM, ask to those crazy guys in the wab that built a 64-Raspberry PI Cluster. Got it?</p>

<h3 id="scenario">Scenario</h3>
<p>I will talk about a really simple (also, not so efficient) scenario: 2 EC2 machines, the first one to run a Jenkins and the second one to run docker-daemon. I will not go through the details about how to setup a Jenkins CI/CD pipeline, there are plenty of guides better than mine. Instead, I will show you the step to automatically reach your instances after each reboot: this problem is arised by AWS, because each time you reboot an instance, if no Elastic IP (more <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html">here</a>) is attached, another Public IP will be assigned and you don’t know a priori which one. First, let’s talk about scheduling of start and stop.</p>

<h4 id="step-15-start-and-stop-your-instances">Step 1/5: Start and Stop your instances</h4>
<p>There are many ways (maybe?) to start and stop your instances: I decided to use AWS Lambda because you can easily create and manage them. This time I decided to use Python to build my StartAndStop Lambda. Before going ahead with code, please remember to assign the right policy to the Role used by the Lambda function (you can choose the role during the setup after the click of Create Function button). From the official AWS Doc, the Statement to add to the policy attached to the Role you choose is the following:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
    </span><span class="s2">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"ec2:Start*"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"ec2:Stop*"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="s2">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>The code of the function is really simple:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">boto3</span><span class="p">,</span> <span class="n">os</span>

<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="n">ec2</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">'ec2'</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'region'</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s">'instances'</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span> <span class="s">"message"</span> <span class="p">:</span> <span class="s">"No instances passed"</span> <span class="p">}</span>

    <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s">'action'</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">)</span> <span class="o">!=</span> <span class="s">'start'</span> <span class="ow">and</span> <span class="n">event</span><span class="p">[</span><span class="s">'action'</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">)</span> <span class="o">!=</span> <span class="s">'stop'</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span> <span class="s">"message"</span> <span class="p">:</span> <span class="s">"Passed action not allowed: '"</span> <span class="o">+</span> <span class="n">event</span><span class="p">[</span><span class="s">'action'</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">)</span> <span class="o">+</span> <span class="s">" over '"</span> <span class="o">+</span> <span class="n">event</span><span class="p">[</span><span class="s">'action'</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">)</span><span class="o">+</span><span class="s">"'"</span> <span class="p">}</span>

    <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s">'action'</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">)</span> <span class="o">==</span> <span class="s">'start'</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">start_instances</span><span class="p">(</span><span class="n">InstanceIds</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s">'instances'</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s">'action'</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">)</span> <span class="o">==</span> <span class="s">'stop'</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">stop_instances</span><span class="p">(</span><span class="n">InstanceIds</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s">'instances'</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">response</span></code></pre></figure>

<p>This AWS Lambda use <code class="highlighter-rouge">boto3</code> library to start and stop instances: the expected request is like the following:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="s2">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stop"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"instances"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"YourJenkinsInstanceID"</span><span class="p">,</span><span class="w"> </span><span class="s2">"YourDockerInstanceID"</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>Done? Let’s go with CloudWatch Events.</p>

<h4 id="step-25-schedule-aws-lambda-execution">Step 2/5: Schedule AWS Lambda execution</h4>
<p>Amazon CloudWatch Events delivers a near real-time stream of system events that describe changes in Amazon Web Services (AWS) resources. Using simple rules that you can quickly set up, you can match events and route them to one or more target functions or streams. More in details, I used <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/ScheduledEvents.html">ScheduledEvents</a> function to schedule my Lambda: with Scheduled Events, you can create rules that self-trigger on an automated schedule in CloudWatch Events using cron or rate expressions. All scheduled events use UTC time zone and the minimum precision for schedules is 1 minute.</p>

<table>
  <thead>
    <tr>
      <th>Field</th>
      <th>Values</th>
      <th>Wildcards</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Minutes</td>
      <td>0-59</td>
      <td>, - * /</td>
    </tr>
    <tr>
      <td>Hours</td>
      <td>0-23</td>
      <td>, - * /</td>
    </tr>
    <tr>
      <td>Day-of-month</td>
      <td>1-31</td>
      <td>, - * ? / L W</td>
    </tr>
    <tr>
      <td>Month</td>
      <td>1-12 or JAN-DEC</td>
      <td>, - * /</td>
    </tr>
    <tr>
      <td>Day-of-week</td>
      <td>1-7 or SUN-SAT</td>
      <td>, - * ? L #</td>
    </tr>
    <tr>
      <td>Year</td>
      <td>1970-2199</td>
      <td>, - * /</td>
    </tr>
  </tbody>
</table>

<p>I want to start my docker-daemon and jenkins server both at 9am and stop them at 9pm. To do that:</p>

<ul>
  <li>First, open <a href="https://console.aws.amazon.com/cloudwatch/">CloudWatch Console</a>, then click on <strong>Rules</strong> on the left;</li>
  <li>Click on the blue button Create Rule, select Schedule, select cron expression and place your expression. My cron expression to start each day (forever) my instances is the following, but you have to deal with UTC and your timezone of course.</li>
</ul>

<p><span style="color:#A04279; font-size: bold;">            0 8 * * ? *</span></p>

<ul>
  <li>Then, on the right panel, click on the Add target button. Choose Lambda from the select box, then select the AWS Lambda function created in the Step 1. In Configure input form, click on Constant and copy and paste - with your instance ids:</li>
</ul>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w"> </span><span class="s2">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"start"</span><span class="p">,</span><span class="w"> </span><span class="s2">"instances"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"YourJenkinsInstanceID"</span><span class="p">,</span><span class="w"> </span><span class="s2">"YourDockerInstanceID"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span></code></pre></figure>

<ul>
  <li>Finally, click on configure details and - it’s just a suggest - write the Instance IDs involved in the request in your description. To test if the rule triggers you can setup cron to run after a few mitutes and then change to the desired time.</li>
</ul>

<p align="center"><img src="http://image.ibb.co/eFU59c/rules_1.png" style="width: 100%; marker-top: -10px;" /></p>

<p>To stop instances, create another rule with	0 20 * * ? * - remember that it is UTC time zone!!! - and invoke the same AWS Lambda function with action value equal to “stop” in your Constant JSON input.</p>

<h4 id="step-35-have-always-updated-dns">Step 3/5: Have always updated DNS</h4>
<p>The best way to deal with Public DNS is by assigning an Elastip IP to your instances, or setup a third-level-domain service inside each of your instance (like no-ip)…or use again Lambda (and Slack) to alert you whanever there is a change of status.</p>

<p>This time, the IAM Policy System requires from you (actually, your Lambda function) something more: this function should be able to ask for instance details. To do that, it needs - at least - read access to EC2 Instances details (I think there is a policy to do that). In any case, you don’t have to deal with super restrictive policy, because your Lambda is not exposed through API Gateway and is called only by a CloudWatch Event. Thus, you can add - at least, for this experiment - the <em>AmazonEC2FullAccess</em> managed policy (<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_examples_ec2_region.html">this</a> is the description page, I guess) to your Role.</p>

<p>For this Lambda, I used Node.js (just to make things a little bit confusing for you). First, install <code class="highlighter-rouge">slack-node</code> in the folder you will upload to your AWS Lambda Console with the command</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="err">npm</span><span class="w"> </span><span class="err">install</span><span class="w"> </span><span class="err">slack-node</span><span class="w"> </span><span class="err">--save</span></code></pre></figure>

<p>Then, create a <code class="highlighter-rouge">index.js</code> file in the folder and copy and paste the following.</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">Slack</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"slack-node"</span><span class="p">);</span>
<span class="c1">// Load the AWS SDK for Node.js</span>
<span class="kd">const</span> <span class="nx">AWS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"aws-sdk"</span><span class="p">);</span>
<span class="c1">// Set the region </span>
<span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="na">region</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REGION</span><span class="p">});</span>

<span class="c1">// Create EC2 service object</span>
<span class="kd">var</span> <span class="nx">ec2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">EC2</span><span class="p">();</span>

<span class="kd">function</span> <span class="nx">composeMsg</span><span class="p">(</span><span class="nx">infos</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">info</span> <span class="k">of</span> <span class="nx">infos</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">msg</span> <span class="o">+=</span> <span class="s2">"Instance: "</span><span class="o">+</span><span class="nx">info</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span><span class="o">+</span><span class="s2">" (id: "</span><span class="o">+</span><span class="nx">info</span><span class="p">[</span><span class="s2">"id"</span><span class="p">]</span><span class="o">+</span><span class="s2">", ip: "</span><span class="o">+</span><span class="nx">info</span><span class="p">[</span><span class="s2">"ip"</span><span class="p">]</span><span class="o">+</span><span class="s2">") has status "</span><span class="o">+</span><span class="nx">info</span><span class="p">[</span><span class="s2">"status"</span><span class="p">]</span><span class="o">+</span><span class="s2">"</span><span class="err">\</span><span class="s2">n"</span><span class="o">+</span><span class="s2">"PublicDNS: "</span><span class="o">+</span><span class="nx">info</span><span class="p">[</span><span class="s2">"dns"</span><span class="p">]</span><span class="o">+</span><span class="s2">"</span><span class="err">\</span><span class="s2">n</span><span class="err">\</span><span class="s2">n"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">msg</span><span class="p">;</span>

<span class="p">}</span>

<span class="kd">function</span> <span class="nx">slackNotifier</span><span class="p">(</span><span class="nx">infos</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="nx">composeMsg</span><span class="p">(</span><span class="nx">infos</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">webhookUri</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_AWS_WEBHOOK</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">slack</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Slack</span><span class="p">();</span>
    <span class="nx">slack</span><span class="p">.</span><span class="nx">setWebhook</span><span class="p">(</span><span class="nx">webhookUri</span><span class="p">);</span>

    <span class="nx">slack</span><span class="p">.</span><span class="nx">webhook</span><span class="p">({</span>
        <span class="na">channel</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_AWS_CHANNEL</span><span class="p">,</span>
        <span class="na">username</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_AWS_BOT_NAME</span><span class="p">,</span>
        <span class="na">text</span><span class="p">:</span> <span class="nx">msg</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">msg</span><span class="p">;</span>

<span class="p">}</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="nx">ec2</span><span class="p">.</span><span class="nx">describeInstances</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">infos</span> <span class="o">=</span> <span class="p">[];</span>
            
            <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
            
            <span class="c1">// for each instance</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">reservartion</span> <span class="k">of</span> <span class="nx">data</span><span class="p">[</span><span class="s2">"Reservations"</span><span class="p">])</span> <span class="p">{</span>
                
                <span class="kd">var</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">reservartion</span><span class="p">[</span><span class="s2">"Instances"</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
                <span class="nx">infos</span><span class="p">.</span><span class="nx">push</span><span class="p">({});</span>

                <span class="c1">// find id</span>
                <span class="nx">infos</span><span class="p">[</span><span class="nx">count</span><span class="p">][</span><span class="s2">"id"</span><span class="p">]</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">[</span><span class="s2">"InstanceId"</span><span class="p">];</span>

                <span class="c1">// find name</span>
                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">tag</span> <span class="k">of</span> <span class="nx">instance</span><span class="p">[</span><span class="s2">"Tags"</span><span class="p">])</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">tag</span><span class="p">[</span><span class="s2">"Key"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Name"</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">infos</span><span class="p">[</span><span class="nx">count</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]</span> <span class="o">=</span> <span class="nx">tag</span><span class="p">[</span><span class="s2">"Value"</span><span class="p">];</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="c1">// save status</span>
                <span class="nx">infos</span><span class="p">[</span><span class="nx">count</span><span class="p">][</span><span class="s2">"status"</span><span class="p">]</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">[</span><span class="s2">"State"</span><span class="p">][</span><span class="s2">"Name"</span><span class="p">];</span>

                <span class="c1">// save dns and ip</span>
                <span class="nx">infos</span><span class="p">[</span><span class="nx">count</span><span class="p">][</span><span class="s2">"dns"</span><span class="p">]</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">[</span><span class="s2">"PublicDnsName"</span><span class="p">];</span>
                <span class="nx">infos</span><span class="p">[</span><span class="nx">count</span><span class="p">][</span><span class="s2">"ip"</span><span class="p">]</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">[</span><span class="s2">"PublicIpAddress"</span><span class="p">];</span>
                
                <span class="nx">count</span> <span class="o">=</span> <span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

            <span class="p">}</span>

            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">infos</span><span class="p">);</span>

            <span class="c1">// send message</span>
            <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="nx">slackNotifier</span><span class="p">(</span><span class="nx">infos</span><span class="p">);</span>
            <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">msg</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">};</span></code></pre></figure>

<p>The code simply calls AWS SDK to get informations - in particular, the instance name, id, status, public dns and ip, even if included in the addreess, to copy and past faster - about your running EC2 instances, parse and format them in a pretty format. Then, a message is sent to a private slack channel (see later). So…zip, upload. Done. Environment variable needed are the REGION (aws-region), SLACK_AWS_BOT_NAME (the name of your slack bot), SLACK_AWS_CHANNEL (the name of your channel) and SLACK_AWS_WEBHOOK (the web.. ok, you got it). You can complete missing env vars later: keep them empty.</p>

<p>There are two things to complete yet: 1) attach this rules to a Cloudwatch Event (of course, the change of state for your EC2 instances) and 2) effectively create a slack channel, a slack-app and corresponding webhook for the created channel. What do you want to do first? Don’t worry, I decide for you: let’s create a Slack channel.</p>

<h4 id="step-45-create-a-slack-channel-and-app-and-so-on">Step 4/5: Create a Slack Channel (and App and so on)</h4>

<p><em>Preamble</em>: first of all: if you don’t have a Slack account, sign up <a href="https://slack.com">here</a>. Then, create a work space (it shoule be easy by following instruction after the first access). Done? After that, you should be able to create a channel (I suggetst a private one if this is an experiment). Done? Ok. If you have problem to complete these steps, well… Actually, I can’t help you: I don’t remember, you have to google about them.</p>

<p>To create a Slack App, follow these steps:</p>

<ul>
  <li>Go <a href="https://api.slack.com/apps?new_app=1">here</a>;</li>
  <li>Choose a name for your app, such as AWSStartAndStopBot, or whatever you want, then select the workspace (you should have at least one);</li>
</ul>

<p align="center"><img src="http://image.ibb.co/bN42Nx/slack_1.png" style="width: 100%; marker-top: -10px;" /></p>

<ul>
  <li>Click on the Create App button. You should be redirect to the page of your application a Add features and functionality section;</li>
</ul>

<p align="center"><img src="http://image.ibb.co/d8ndvH/slack_2.png" style="width: 100%; marker-top: -10px;" /></p>

<ul>
  <li>Click on the Incoming Weebhooks below, then setup to ON the switch button in right corner;</li>
</ul>

<p align="center"><img src="http://image.ibb.co/d5TkaH/slack_3.png" style="width: 100%; marker-top: -10px;" /></p>

<ul>
  <li>Go to the bottom of the page and click on the Add new webhook to workspace button. You should be redirected to a page with a select box with a Post to label. Select the private channel created in the preamble, then click on Authorize button;</li>
</ul>

<p align="center"><img src="http://image.ibb.co/dCPQaH/slack_4.png" style="width: 100%; marker-top: -10px;" /></p>

<ul>
  <li>You should be redirected to a previous page with the webhook url (you have to update your SLACK_AWS_WEBHOOK env variable for your AWS Lambda, the Node.js one);</li>
</ul>

<h4 id="step-55-cloudwatch-event-to-sent-slack-message">Step 5/5: CloudWatch Event to sent Slack Message</h4>
<p>The last step is create a CloudWatch Rule - a new one, keep the start and stop previously created rule untouched - triggered: this time, the trigger is not a Schedule event at fixed time, but a an Event Pattern.</p>

<ul>
  <li>First, open <a href="https://console.aws.amazon.com/cloudwatch/">CloudWatch Console</a>, then click on <strong>Rules</strong> on the left;</li>
  <li>Click on the blue button Create Rule, select Event Pattern, then select EC2 from Service Name select box;</li>
  <li>Click on EC2 Instance State-change Notification, then choose the involved state (you can exlude pending, if you want);</li>
  <li>On the left, click on Add trigger, then select the AWS Lambda (Node.js) function and configure input as matched event (it will be ignored);</li>
</ul>

<p align="center"><img src="http://image.ibb.co/g3jGFH/rules_2.png" style="width: 100%; marker-top: -10px;" /></p>

<p>To test the setup, try to stop and start your instances, and you should see something appear on your slack channel!</p>

<p align="center"><img src="http://image.ibb.co/kSQFaH/slack_bot.png" style="width: 100%; marker-top: -10px;" /></p>

<h3 id="other-possible-scenario">Other possible scenario</h3>
<p>I think I will work on Slack features like button to handle my VPC with a sort of question-answer event-driven bot. But…what if you want to add more worker node to Jenkins? For instance, using a 9-17 setup, you can have a three machine running at time.</p>

<p align="center"><img src="http://image.ibb.co/fAOFQH/aws_clock_2.png" style="width: 100%; marker-top: -10px;" /></p>

<p>But I think this setup is more interesting :D. In the end, having a 4 node k8s cluster with a Jenkins for deploy, for 4 hours each day for one year….for free, is not so bad. I will try, I think performance are around 1980 :D</p>

<p align="center"><img src="http://image.ibb.co/eYM25H/aws_clock_3.png" style="width: 100%; marker-top: -10px;" /></p>

<p>Thank you everybody for reading!</p>



<div class="comments">
   <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'made2591';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

</div>

<hr/>


  
    <div class="post-navs row">
      
        <div class="col-md-6 post-nav">

          <h3 class="section-header">
            Older
            <span class="text-muted"> &middot; </span>
            <a href="/archive">View Archive (35)</a>
          </h3>

          <h2 class="post-title-link"><a href="/posts/aws-step-functions">Node.js, DynamoDB, and AWS Step Functions to collect <em>sentimented</em> movie reviews</a></h2>
          <h3 id="introduction">Introduction</h3>
<p>Recently I worked with AWS Lambda and API Gateway to extend my set of personal APIs and collect information from several sources. I wrote an article on that (if you want to <a href="https://made2591.github.io/posts/aws-lambda">have a look</a>). In this article I will talk about the AWS Step Functions service that enable create finite states machines to easy coordinate the components of distributed applications and microservices using visual workflows. Why AWS Step Functions? Because they let me create a tool to gather movie titles in teather, search for reviews about each of them and make a basic sentiment analysis over the review to help me decide what’s worth watching at teather and what’s worth waiting for on Netflix :D
More in general, with AWS Step Functions, you can build applications made of individual components that each perform a discrete function: this lets you scale and change applications quickly. Step Functions is a reliable way to coordinate components and step through the functions of your application. They provides a graphical console to arrange and visualize the components of your application as a series of steps. This makes it simple to build and run multistep applications. Step Functions automatically triggers and tracks each step, and retries when there are errors, so your application executes in order and as expected. Step Functions logs the state of each step, so when things do go wrong, you can diagnose and debug problems quickly.</p>


        </div>
      
      

        <div class="col-md-6 post-nav">
          <h3 class="section-header">
            Newer
            
          </h3>

          <h2 class="post-title-link"><a href="/posts/doing-vs-learning">I'm still learning</a></h2>
          <h3 id="prelude">Prelude</h3>
<p>Ok, first of all: I know, I have already used the yoda picture below <a href="https://made2591.github.io/posts/fundamentals">in the past</a>, but even if I am not at all a fan of the Star Wars saga, I like it. ATTENTION! This is a deeply desperate post: don’t judge me, I’m sad, I’m alone, it’s raining, I don’t feel to have any perspective but there’s a positive thing: I’m still learning. So… let’s divide the complaints by sectors.</p>


        </div>
      
    </div>
  



          <div id="footer">
<hr/>
  <div class="pull-left">
    &copy;2019.
    Built with <a href="http://jekyllrb.com/">Jekyll</a> and
    <a href="https://github.com/kirqe/autm-rb">Autm-rb</a>. Thanks to <a href="https://github.com/kirqe">kirqe</a>.
  </div>

  <div class="pull-right">
    <span class="credits pull-right social">
      
        
          <a href="https://github.com/made2591/" target="_blank"><i class="fa fa-github"></i></a>
        
      
        
          <a href="https://twitter.com/made2591" target="_blank"><i class="fa fa-twitter"></i></a>
        
      
        
          <a href="https://linkedin.com/in/mmadeddu" target="_blank"><i class="fa fa-linkedin"></i></a>
        
      
        
          <a href="https://www.facebook.com/matteo.madeddu" target="_blank"><i class="fa fa-facebook"></i></a>
        
      
    </span>
  </div>
</div>

        </section>
    </div>
    </div>
    <script src="/public/javascripts/jquery.min.js"></script>
    <script src="/public/javascripts/bootstrap.min.js"></script>
    <!-- Place your <script> tags here. -->

<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>

<script id="dsq-count-scr" src="//made2591-github-io.disqus.com/count.js" async></script>

<!-- disqus comment counter -->
<script type="text/javascript">
	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'made2591-github-io';

	/* * * DON'T EDIT BELOW THIS LINE * * */
	(function () {
	    var s = document.createElement('script'); s.async = true;
	    s.type = 'text/javascript';
	    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
	    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
	}());
</script>
<!-- /disqus comment counter -->

<!-- google analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-111283556-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-111283556-1');
</script>
<!-- /google analytics -->

  </body>
</html>
